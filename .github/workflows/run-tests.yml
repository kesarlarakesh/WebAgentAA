name: Browser Automation Tests

on:
  # Trigger on push to main branch
  push:
    branches: [ main ]
  
  # Trigger on pull request
  pull_request:
    branches: [ main ]
  
  # Allow manual trigger from Actions tab
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Test type to run'
        required: true
        default: 'single'
        type: choice
        options:
          - single
          - multiple
          - priority
          - category
  
  # Schedule to run daily at 9 AM UTC
  schedule:
    - cron: '0 9 * * *'

# Set minimal permissions for GITHUB_TOKEN
permissions:
  contents: read
  actions: read
  checks: write

jobs:
  # Security and lint check job
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install bandit safety flake8
      
      - name: Run Bandit security scan
        run: bandit -r . -f json -o bandit-report.json || true
        continue-on-error: true
      
      - name: Run Safety vulnerability check
        run: safety check --json || true
        continue-on-error: true
      
      - name: Run Flake8 linting
        run: flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || true
        continue-on-error: true
      
      - name: Upload security reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            bandit-report.json
          retention-days: 30

  test:
    runs-on: ubuntu-latest
    needs: security-scan
    outputs:
      custom_report_url: ${{ steps.upload-reports.outputs.custom_report_url }}
      bucket_url: ${{ steps.upload-reports.outputs.bucket_url }}
      gcs_folder: ${{ steps.upload-reports.outputs.gcs_folder }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          playwright install chromium
          playwright install-deps chromium
      
      - name: Create .env file from secrets
        run: |
          cat << EOF > .env
          GOOGLE_API_KEY=${{ secrets.GOOGLE_API_KEY }}
          GOOGLE_SHEETS_CREDENTIALS=./google-sheets-credentials.json
          EOF
      
      - name: Create Google Sheets credentials file
        run: |
          echo '${{ secrets.GOOGLE_SHEETS_CREDENTIALS_JSON }}' > google-sheets-credentials.json
      
      - name: Run single task test
        if: github.event_name != 'workflow_dispatch' || github.event.inputs.test_type == 'single'
        run: python run_single_task.py
      
      - name: Run multiple tasks test
        if: github.event.inputs.test_type == 'multiple'
        run: python run_multiple_tasks.py
      
      - name: Run priority-based test
        if: github.event.inputs.test_type == 'priority'
        run: python run_by_priority.py
      
      - name: Run category-based test
        if: github.event.inputs.test_type == 'category'
        run: python run_by_category.py
      
      # Google Cloud SDK Setup and Report Upload
      - name: Authenticate to Google Cloud
        if: always()
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
      
      - name: Setup Google Cloud SDK
        if: always()
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Upload Reports to Google Cloud Storage
        if: always()
        id: upload-reports
        run: |
          set -e
          
          GCS_FOLDER="webagentreports"
          BUCKET_NAME="aawebagentreports"
          
          if [ ! -d "reports" ]; then
            echo "No reports directory found"
            echo "gcs_folder=${GCS_FOLDER}" >> "${GITHUB_OUTPUT}"
            echo "custom_report_url=" >> "${GITHUB_OUTPUT}"
            echo "bucket_url=https://console.cloud.google.com/storage/browser/${BUCKET_NAME}/${GCS_FOLDER}" >> "${GITHUB_OUTPUT}"
            exit 0
          fi
          
          echo "Found reports directory"
          ls -la reports/
          
          echo "Uploading reports to gs://${BUCKET_NAME}/${GCS_FOLDER}/"
          gsutil -m cp -r reports "gs://${BUCKET_NAME}/${GCS_FOLDER}/" || {
            echo "Failed to upload reports"
            exit 1
          }
          
          echo "Setting public access..."
          gsutil -m acl ch -r -u AllUsers:R "gs://${BUCKET_NAME}/${GCS_FOLDER}/reports/" || {
            echo "Warning: Failed to set public access"
          }
          
          CUSTOM_URL=""
          if [ -f "reports/index.html" ]; then
            CUSTOM_URL="https://storage.googleapis.com/${BUCKET_NAME}/${GCS_FOLDER}/reports/index.html"
            echo "Custom report URL: ${CUSTOM_URL}"
          fi
          
          echo "gcs_folder=${GCS_FOLDER}" >> "${GITHUB_OUTPUT}"
          echo "custom_report_url=${CUSTOM_URL}" >> "${GITHUB_OUTPUT}"
          echo "bucket_url=https://console.cloud.google.com/storage/browser/${BUCKET_NAME}/${GCS_FOLDER}" >> "${GITHUB_OUTPUT}"
          
          echo "Upload completed successfully"
      
      - name: Upload HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: reports
          path: reports/
          retention-days: 30
      
      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: failure-logs
          path: |
            reports/
            *.log
          retention-days: 7

  notify:
    runs-on: ubuntu-latest
    needs: test
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
      
      - name: Download test results
        uses: actions/download-artifact@v4
        with:
          name: reports
          path: ./
      
      - name: Extract Test Statistics
        id: extract-stats
        run: |
          # Check for test results file
          echo "Looking for test results..."
          
          # First check standard location
          if [ -f "reports/json-report.json" ]; then
            JSON_PATH="reports/json-report.json"
            echo "Found report at: $JSON_PATH"
          else
            # Look for any JSON files in reports directory
            JSON_FILES=$(find . -path "*/reports/*.json" 2>/dev/null)
            
            if [ -n "$JSON_FILES" ]; then
              JSON_PATH=$(echo "$JSON_FILES" | head -n 1)
              echo "Using alternative report: $JSON_PATH"
            else
              echo "No test report files found"
              JSON_PATH=""
            fi
          fi
          
          # Process test results if file exists
          if [ -n "$JSON_PATH" ] && [ -f "$JSON_PATH" ]; then
            # Install jq if not available (ensures it's present)
            if ! command -v jq &> /dev/null; then
              echo "Installing jq for JSON parsing"
              sudo apt-get update && sudo apt-get install -y jq
            fi
            
            # Extracting test statistics with jq
            # First, check the structure to determine the proper jq query
            echo "Analyzing JSON structure..."
            
            # Count test results by status
            TOTAL=$(jq -r '.metadata.total_tests // 0' "$JSON_PATH")
            PASSED=$(jq -r '.metadata.passed_tests // 0' "$JSON_PATH")
            FAILED=$(jq -r '.metadata.failed_tests // 0' "$JSON_PATH")
            
            # Calculate flaky and skipped (if applicable in future)
            FLAKY=0
            SKIPPED=0
            
            echo "Test Statistics:"
            echo "Total: $TOTAL"
            echo "Passed: $PASSED"
            echo "Failed: $FAILED"
            echo "Flaky: $FLAKY"
            echo "Skipped: $SKIPPED"
          else
            echo "‚ö†Ô∏è No test results found, using default values"
            TOTAL=0
            PASSED=0
            FAILED=0
            FLAKY=0
            SKIPPED=0
          fi
          
          # Set outputs for use in next step
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "flaky=$FLAKY" >> $GITHUB_OUTPUT
          echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT
          
          # Create a summary for direct use in the notification
          echo "summary=Total: $TOTAL | Passed: $PASSED | Failed: $FAILED | Flaky: $FLAKY | Skipped: $SKIPPED" >> $GITHUB_OUTPUT
      
      - name: Notify Slack
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_TITLE: "Test Results"
          SLACK_MESSAGE: |
            *Test Statistics*
            Total: ${{ steps.extract-stats.outputs.total }}
            Passed: ${{ steps.extract-stats.outputs.passed }} ‚úÖ
            Failed: ${{ steps.extract-stats.outputs.failed }} ‚ùå
            Flaky: ${{ steps.extract-stats.outputs.flaky }} ‚ö†Ô∏è
            Skipped: ${{ steps.extract-stats.outputs.skipped }} ‚è≠Ô∏è
            
            *Build Information*
            Build: ${{ github.run_id }}
            Commit: ${{ github.sha }}
            Branch: ${{ github.ref_name }}
            Run URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            *Test Reports (Google Cloud Storage)*
            üìä Custom Report: ${{ needs.test.outputs.custom_report_url }}
            üóÇÔ∏è GCS Console: ${{ needs.test.outputs.bucket_url }}

