name: AA Agent Automation Tests

on:
  # Trigger on push to main branch
  push:
    branches: [ main ]
  
  # Trigger on pull request
  pull_request:
    branches: [ main ]
  
  # Allow manual trigger from Actions tab
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Test type to run'
        required: true
        default: 'single'
        type: choice
        options:
          - single
          - multiple
          - priority
          - category
      test_environment:
        description: 'Test environment (local or lambdatest)'
        required: true
        default: 'local'
        type: choice
        options:
          - local
          - lambdatest
  
  # Schedule to run daily at 9 AM UTC
  schedule:
    - cron: '0 9 * * *'

# Set minimal permissions for GITHUB_TOKEN
permissions:
  contents: read
  actions: read
  checks: write

jobs:
  # Security and lint check job
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install bandit safety flake8
      
      - name: Run Bandit security scan
        run: bandit -r . -f json -o bandit-report.json || true
        continue-on-error: true
      
      - name: Run Safety vulnerability check
        run: safety check --json || true
        continue-on-error: true
      
      - name: Run Flake8 linting
        run: flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || true
        continue-on-error: true
      
      - name: Upload security reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            bandit-report.json
          retention-days: 30

  test:
    runs-on: ubuntu-latest
    needs: security-scan
    env:
      LT_USERNAME: ${{ secrets.LT_USERNAME }}
      LT_ACCESS_KEY: ${{ secrets.LT_ACCESS_KEY }}
    outputs:
      custom_report_url: ${{ steps.upload-reports.outputs.custom_report_url }}
      bucket_url: ${{ steps.upload-reports.outputs.bucket_url }}
      gcs_folder: ${{ steps.upload-reports.outputs.gcs_folder }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          playwright install chromium
          playwright install-deps chromium
      
      - name: Create .env file from secrets
        run: |
          cat << EOF > .env
          GOOGLE_API_KEY=${{ secrets.GOOGLE_API_KEY }}
          GOOGLE_SHEETS_CREDENTIALS=./google-sheets-credentials.json
          EOF
      
      - name: Create Google Sheets credentials file
        run: |
          echo '${{ secrets.GOOGLE_SHEETS_CREDENTIALS_JSON }}' > google-sheets-credentials.json
      
      - name: Run single task test (Local)
        if: (github.event_name != 'workflow_dispatch' || github.event.inputs.test_type == 'single') && (github.event.inputs.test_environment == 'local' || github.event.inputs.test_environment == null)
        env:
          USE_LAMBDATEST: false
        run: python run_single_task.py
      
      - name: Run single task test (LambdaTest)
        if: (github.event_name != 'workflow_dispatch' || github.event.inputs.test_type == 'single') && github.event.inputs.test_environment == 'lambdatest'
        env:
          USE_LAMBDATEST: true
        run: python run_single_task.py
      
      - name: Run multiple tasks test (Local)
        if: github.event.inputs.test_type == 'multiple' && (github.event.inputs.test_environment == 'local' || github.event.inputs.test_environment == null)
        env:
          USE_LAMBDATEST: false
        run: python run_multiple_tasks.py
      
      - name: Run multiple tasks test (LambdaTest)
        if: github.event.inputs.test_type == 'multiple' && github.event.inputs.test_environment == 'lambdatest'
        env:
          USE_LAMBDATEST: true
        run: python run_multiple_tasks.py
      
      - name: Run priority-based test (Local)
        if: github.event.inputs.test_type == 'priority' && (github.event.inputs.test_environment == 'local' || github.event.inputs.test_environment == null)
        env:
          USE_LAMBDATEST: false
        run: python run_by_priority.py
      
      - name: Run priority-based test (LambdaTest)
        if: github.event.inputs.test_type == 'priority' && github.event.inputs.test_environment == 'lambdatest'
        env:
          USE_LAMBDATEST: true
        run: python run_by_priority.py
      
      - name: Run category-based test (Local)
        if: github.event.inputs.test_type == 'category' && (github.event.inputs.test_environment == 'local' || github.event.inputs.test_environment == null)
        env:
          USE_LAMBDATEST: false
        run: python run_by_category.py
      
      - name: Run category-based test (LambdaTest)
        if: github.event.inputs.test_type == 'category' && github.event.inputs.test_environment == 'lambdatest'
        env:
          USE_LAMBDATEST: true
        run: python run_by_category.py
      
      # Google Cloud SDK Setup and Report Upload
      - name: Authenticate to Google Cloud
        if: always()
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
      
      - name: Setup Google Cloud SDK
        if: always()
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Upload Reports to Google Cloud Storage
        if: always()
        id: upload-reports
        run: |
          set -e
          
          # Determine folder based on test environment
          TEST_ENV="${{ github.event.inputs.test_environment || 'local' }}"
          if [ "$TEST_ENV" = "lambdatest" ]; then
            GCS_FOLDER="webagentreports/lambdatest"
          else
            GCS_FOLDER="webagentreports/local"
          fi
          
          BUCKET_NAME="aawebagentreports"
          GCS_REPORTS_PATH="${GCS_FOLDER}/reports"
          
          if [ ! -d "reports" ]; then
            echo "No reports directory found"
            echo "gcs_folder=${GCS_FOLDER}" >> "${GITHUB_OUTPUT}"
            echo "custom_report_url=" >> "${GITHUB_OUTPUT}"
            echo "bucket_url=https://console.cloud.google.com/storage/browser/${BUCKET_NAME}/${GCS_FOLDER}" >> "${GITHUB_OUTPUT}"
            exit 0
          fi
          
          echo "Found reports directory"
          ls -la reports/
          
          # Find all run_* directories
          echo "Listing run directories..."
          ls -la reports/run_* 2>/dev/null || echo "No run directories found"
          
          # Upload each run directory and index.html to GCS
          echo "Uploading main index.html to gs://${BUCKET_NAME}/${GCS_REPORTS_PATH}/"
          if [ -f "reports/index.html" ]; then
            gsutil cp "reports/index.html" "gs://${BUCKET_NAME}/${GCS_REPORTS_PATH}/index.html" || {
              echo "Failed to upload main index.html"
              exit 1
            }
          fi
          
          # Upload all run_* directories
          echo "Uploading run directories to gs://${BUCKET_NAME}/${GCS_REPORTS_PATH}/"
          for run_dir in reports/run_*; do
            if [ -d "$run_dir" ]; then
              run_name=$(basename "$run_dir")
              echo "Uploading $run_name..."
              gsutil -m cp -r "$run_dir" "gs://${BUCKET_NAME}/${GCS_REPORTS_PATH}/" || {
                echo "Failed to upload $run_name"
                exit 1
              }
            fi
          done
          
          echo "Setting public access..."
          gsutil -m acl ch -r -u AllUsers:R "gs://${BUCKET_NAME}/${GCS_REPORTS_PATH}/" || {
            echo "Warning: Failed to set public access"
          }
          
          CUSTOM_URL=""
          if [ -f "reports/index.html" ]; then
            CUSTOM_URL="https://storage.googleapis.com/${BUCKET_NAME}/${GCS_REPORTS_PATH}/index.html"
            echo "Custom report URL: ${CUSTOM_URL}"
          fi
          
          echo "gcs_folder=${GCS_FOLDER}" >> "${GITHUB_OUTPUT}"
          echo "custom_report_url=${CUSTOM_URL}" >> "${GITHUB_OUTPUT}"
          echo "bucket_url=https://console.cloud.google.com/storage/browser/${BUCKET_NAME}/${GCS_REPORTS_PATH}" >> "${GITHUB_OUTPUT}"
          
          echo "Upload completed successfully"
      
      - name: Upload HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: reports
          path: reports/
          retention-days: 30
      
      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: failure-logs
          path: |
            reports/
            *.log
          retention-days: 7

  notify:
    runs-on: ubuntu-latest
    needs: test
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download test results
        uses: actions/download-artifact@v4
        with:
          name: reports
          path: ./reports
      
      - name: Extract Test Statistics
        id: extract-stats
        run: |
          echo "Looking for test results..."
          
          # Debug: List downloaded files
          echo "Contents of current directory:"
          ls -la
          echo "Contents of reports directory:"
          ls -la reports/ || echo "reports directory not found"
          
          # Check for JSON report file in timestamped subdirectories
          JSON_PATH=""
          
          # Look for the latest run directory
          LATEST_RUN=$(find reports -maxdepth 1 -type d -name "run_*" | sort -r | head -n 1)
          
          if [ -n "$LATEST_RUN" ] && [ -d "$LATEST_RUN" ]; then
            echo "Found latest run directory: $LATEST_RUN"
            ls -la "$LATEST_RUN"
            
            # Look for JSON report in the run directory
            JSON_FILE=$(find "$LATEST_RUN" -name "json_report_*.json" -type f | head -n 1)
            if [ -n "$JSON_FILE" ]; then
              JSON_PATH="$JSON_FILE"
              echo "Found JSON report: $JSON_PATH"
            fi
          else
            echo "No run directories found, checking for JSON files in reports root..."
            # Fallback: search for any JSON file
            find . -name "*.json" -type f
            JSON_FILES=$(find . -name "json*.json" -type f -print -quit 2>/dev/null)
            if [ -n "$JSON_FILES" ]; then
              JSON_PATH="$JSON_FILES"
              echo "Using alternative report: $JSON_PATH"
            fi
          fi
          
          # Extract statistics from JSON or use defaults
          if [ -n "$JSON_PATH" ] && [ -f "$JSON_PATH" ]; then
            echo "Reading JSON file: $JSON_PATH"
            cat "$JSON_PATH"
            
            # Install jq if needed
            if ! command -v jq &> /dev/null; then
              echo "Installing jq..."
              sudo apt-get update -qq && sudo apt-get install -y -qq jq
            fi
            
            # Extract test statistics
            TOTAL=$(jq -r '.metadata.total_tests // 0' "$JSON_PATH")
            PASSED=$(jq -r '.metadata.passed_tests // 0' "$JSON_PATH")
            FAILED=$(jq -r '.metadata.failed_tests // 0' "$JSON_PATH")
            FLAKY=0
            SKIPPED=0
            
            echo "Test Statistics: Total=$TOTAL, Passed=$PASSED, Failed=$FAILED"
          else
            echo "No test results found, using defaults"
            TOTAL=0
            PASSED=0
            FAILED=0
            FLAKY=0
            SKIPPED=0
          fi
          
          # Set outputs
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "flaky=$FLAKY" >> $GITHUB_OUTPUT
          echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT
      
      - name: Notify Slack
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_TITLE: "Test Results"
          SLACK_MESSAGE: |
            *Test Statistics*
            Total: ${{ steps.extract-stats.outputs.total }}
            Passed: ${{ steps.extract-stats.outputs.passed }} ‚úÖ
            Failed: ${{ steps.extract-stats.outputs.failed }} ‚ùå
            Flaky: ${{ steps.extract-stats.outputs.flaky }} ‚ö†Ô∏è
            Skipped: ${{ steps.extract-stats.outputs.skipped }} ‚è≠Ô∏è
            
            *Build Information*
            Build: ${{ github.run_id }}
            Commit: ${{ github.sha }}
            Branch: ${{ github.ref_name }}
            Run URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            *Test Reports (Google Cloud Storage)*
            üìä Custom Report: ${{ needs.test.outputs.custom_report_url }}
            üóÇÔ∏è GCS Console: ${{ needs.test.outputs.bucket_url }}

